include_directories("${PROJECT_SOURCE_DIR}/include")

file(GLOB sources "${PROJECT_SOURCE_DIR}/src/*.c")
list(REMOVE_ITEM sources "${PROJECT_SOURCE_DIR}/src/main.c")

file(GLOB tests "${PROJECT_SOURCE_DIR}/test/*.cpp")
list(REMOVE_ITEM tests "${PROJECT_SOURCE_DIR}/test/main.cpp")

add_test(NAME integration_test
    message(STATUS "Current dir : ${CMAKE_CURRENT_LIST_DIR}")
    execute_process(
    COMMAND bundle exec rspec ${CMAKE_CURRENT_LIST_DIR}/../..
    -d ${CMAKE_BINARY_DIR}/data
    ERROR_VARIABLE DOWNLOAD_ERROR)
    WORKING_DIRECTORY ${EXECUTABLE_OUTPUT_PATH})

foreach(file ${tests})
    set(name)
    get_filename_component(name ${file} NAME_WE)
    add_executable("${name}_tests"
        ${sources}
        ${file}
        "${PROJECT_SOURCE_DIR}/test/main.cpp")
    target_link_libraries("${name}_tests" gtest_main)
    target_link_libraries("${name}_tests" gmock_main)

    # make test are working at ${PROJECT_SOURCE_DIR}/test,
    # so we can access testdata
    # https://stackoverflow.com/a/48230045
    add_test(NAME ${name}
        COMMAND
        "${name}_tests"
        WORKING_DIRECTORY ${PROJECT_SOURCE_DIR}/test)
endforeach()